<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>설계사 목표 실적 관리 시스템 - 통합형</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }

        .progress-container {
            position: relative;
            height: 32px;
            background-color: #f1f5f9;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.5s ease;
        }

        .target-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #f87171;
            z-index: 10;
        }

        .target-label {
            position: absolute;
            top: -20px;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 600;
            color: #ef4444;
            white-space: nowrap;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.01);
            border: 1px solid #f1f5f9;
        }

        .employee-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .employee-item.active {
            background-color: #f0f7ff;
            border-color: #bfdbfe;
        }

        .list-delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .employee-item:hover .list-delete-btn {
            opacity: 1;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(4px);
            z-index: 1100;
            align-items: center;
            justify-content: center;
        }

        .history-item {
            border-left: 2px solid #f1f5f9;
            padding-left: 14px;
            position: relative;
            padding-bottom: 12px;
            transition: all 0.2s;
        }
        .history-item::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 6px;
            width: 8px;
            height: 8px;
            background: #cbd5e1;
            border-radius: 50%;
        }
        .history-item:hover {
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto space-y-8">
        <!-- 상단 헤더 및 동기화 버튼 -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">2월 설계사 실적 대시보드</h1>
                <p class="text-slate-500 text-sm">실시간 목표 달성 현황</p>
            </div>
            <button id="refresh-btn" class="bg-white text-slate-600 px-5 py-2.5 rounded-xl font-bold border border-slate-200 hover:bg-slate-50 hover:text-blue-600 transition shadow-sm flex items-center gap-2 group">
                <i class="fa-solid fa-rotate group-hover:rotate-180 transition-transform duration-500"></i> 데이터 전체 동기화
            </button>
        </div>

        <!-- 상단 요약 대시보드 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card p-6 border-l-4 border-blue-400">
                <div class="text-slate-400 text-sm font-medium">전체 합산 실적</div>
                <div class="text-3xl font-bold text-slate-700" id="summary-total-perf">0원</div>
            </div>
            <div class="card p-6 border-l-4 border-green-400">
                <div class="text-slate-400 text-sm font-medium">평균 달성률</div>
                <div class="text-3xl font-bold text-slate-700" id="summary-avg-rate">0%</div>
            </div>
            <div class="card p-6 border-l-4 border-slate-400">
                <div class="text-slate-400 text-sm font-medium">관리 설계사 수</div>
                <div class="text-3xl font-bold text-slate-700" id="summary-count">0명</div>
            </div>
        </div>

        <!-- 설계사 리스트 대시보드 -->
        <div class="card p-8">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4 border-b border-slate-50 pb-6">
                <h2 class="font-bold text-slate-600 flex items-center gap-3 text-xl">
                    <i class="fa-solid fa-users text-blue-400"></i> 설계사 리스트
                </h2>
                <div class="flex gap-3 max-w-sm w-full">
                    <input type="text" id="new-emp-name" class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-100 transition" placeholder="이름 입력">
                    <button id="add-emp-btn" class="bg-blue-500 text-white px-6 py-2 rounded-xl text-sm font-semibold hover:bg-blue-600 transition shadow-sm whitespace-nowrap">추가</button>
                </div>
            </div>
            
            <div id="employee-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="text-center col-span-full py-12 text-slate-400 text-lg italic font-medium">등록된 설계사가 없습니다.</div>
            </div>
        </div>

        <!-- 하단: 상세 대시보드 -->
        <div id="empty-state" class="card p-20 flex flex-col items-center justify-center text-center">
            <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mb-6">
                <i class="fa-solid fa-user-check text-4xl text-slate-200"></i>
            </div>
            <h3 class="text-xl font-semibold text-slate-600 mb-2">상세 정보를 보려면 설계사를 선택해주세요</h3>
            <p class="text-slate-400">위 리스트에서 설계사를 클릭하면 상세 실적 추이를 관리할 수 있습니다.</p>
        </div>

        <div id="detail-dashboard" class="hidden space-y-8 animate-fade-in pb-12">
            <div class="card p-8">
                <div class="flex justify-between items-start mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 tracking-tight" id="detail-name">홍길동</h2>
                        <p class="text-sm text-slate-400 mt-1">개별 실적 상세 현황 (2026년 2월)</p>
                    </div>
                    <button id="delete-emp-btn" class="text-slate-300 hover:text-red-400 transition-colors p-2">
                        <i class="fa-solid fa-trash-can text-lg"></i>
                    </button>
                </div>

                <div class="flex justify-between items-end mb-12">
                    <div>
                        <span class="text-xs font-semibold text-slate-400 uppercase tracking-widest">현재 달성액</span>
                        <div class="text-5xl font-bold text-blue-500 mt-2" id="display-current">0원</div>
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-semibold text-slate-400 uppercase tracking-widest">최종 목표 달성률</span>
                        <div class="text-3xl font-bold text-slate-600 mt-2" id="display-percentage">0%</div>
                    </div>
                </div>

                <div class="mb-6 pt-6">
                    <div class="progress-container">
                        <div id="progress-bar" class="progress-bar"></div>
                        <div id="marker1" class="target-marker"><span class="target-label">1차</span></div>
                        <div id="marker2" class="target-marker"><span class="target-label">2차</span></div>
                    </div>
                </div>

                <div id="trend-chart-container" class="mb-12 w-full h-80 bg-slate-50 rounded-2xl p-6 border border-slate-100">
                    <canvas id="trendChart"></canvas>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 pt-8 border-t border-slate-50 text-center">
                    <div>
                        <div class="text-[11px] text-slate-400 font-semibold mb-2 uppercase tracking-tighter">1차 목표</div>
                        <div class="text-lg font-bold text-slate-700" id="stat-target1">0원</div>
                    </div>
                    <div>
                        <div class="text-[11px] text-slate-400 font-semibold mb-2 uppercase tracking-tighter">2차 목표</div>
                        <div class="text-lg font-bold text-slate-700" id="stat-target2">0원</div>
                    </div>
                    <div>
                        <div class="text-[11px] text-slate-400 font-semibold mb-2 uppercase tracking-tighter">실적 합계</div>
                        <div class="text-lg font-bold text-blue-500" id="stat-achieved">0원</div>
                    </div>
                    <div>
                        <div class="text-[11px] text-slate-400 font-semibold mb-2 uppercase tracking-tighter">목표 잔액</div>
                        <div class="text-lg font-bold text-red-400" id="stat-remaining">0원</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card p-8">
                    <h3 class="font-bold text-slate-700 mb-6 flex items-center gap-3">
                        <i class="fa-solid fa-coins text-yellow-400"></i> 실적 합산 추가
                    </h3>
                    <div class="flex flex-col gap-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <input type="date" id="add-date-input" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-100 transition">
                            <input type="number" id="add-value-input" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-100 transition" placeholder="금액 입력">
                        </div>
                        <div class="flex gap-3">
                            <button id="add-perf-btn" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-semibold text-sm hover:bg-blue-600 transition shadow-sm">실적 누적하기</button>
                            <button id="reset-btn" class="px-5 py-3 border border-slate-200 text-slate-400 rounded-xl hover:bg-slate-50 transition" title="초기화"><i class="fa-solid fa-rotate-left"></i></button>
                        </div>
                    </div>
                </div>
                <div class="card p-8">
                    <h3 class="font-bold text-slate-700 mb-6 flex items-center gap-3">
                        <i class="fa-solid fa-bullseye text-red-400"></i> 목표 변경
                    </h3>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <input type="number" id="target1-input" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-100 transition" placeholder="1차 목표">
                        <input type="number" id="target2-input" class="p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-100 transition" placeholder="2차 목표">
                    </div>
                    <button id="set-goals-btn" class="w-full bg-slate-800 text-white py-3 rounded-xl font-semibold text-sm hover:bg-slate-700 transition shadow-sm">설정 적용</button>
                </div>
            </div>

            <div class="card p-8">
                <h3 class="font-bold text-slate-700 mb-6 flex items-center justify-between">
                    <span class="flex items-center gap-3">
                        <i class="fa-solid fa-clock-rotate-left text-slate-300"></i> 누적 실적 이력
                    </span>
                </h3>
                <div id="performance-history" class="max-h-72 overflow-y-auto custom-scroll flex flex-col gap-2">
                    <div class="text-center py-6 text-slate-400 text-sm font-medium">실적 기록이 없습니다.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 알림 -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-8 py-4 rounded-2xl opacity-0 pointer-events-none transition-all duration-300 shadow-2xl z-[1500] font-medium">
        메시지
    </div>

    <!-- 모달 1: 설계사 삭제 확인 -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full mx-4 text-center">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-circle-exclamation text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-3">설계사를 삭제하시겠습니까?</h3>
            <p class="text-slate-500 text-sm mb-8 leading-relaxed">해당 설계사의 모든 실적 데이터가<br>영구적으로 삭제됩니다.</p>
            <div class="flex gap-4">
                <button id="modal-cancel" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition">취소</button>
                <button id="modal-confirm" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition shadow-sm">삭제하기</button>
            </div>
        </div>
    </div>

    <!-- 모달 2: 실적 이력 수정 -->
    <div id="history-edit-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-lg font-bold text-slate-800 mb-6 text-center">실적 금액 수정</h3>
            <input type="number" id="edit-history-input" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-8 outline-none focus:ring-2 focus:ring-blue-100 transition text-center text-xl font-bold text-blue-600" placeholder="금액 입력">
            <div class="flex gap-4">
                <button id="history-edit-cancel" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition">취소</button>
                <button id="history-edit-confirm" class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition shadow-sm">저장</button>
            </div>
        </div>
    </div>

    <!-- 모달 3: 이력 개별 삭제 확인 -->
    <div id="history-delete-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full mx-4 text-center">
            <h3 class="text-xl font-bold text-slate-800 mb-3">이력을 삭제하시겠습니까?</h3>
            <p class="text-slate-500 text-sm mb-8 leading-relaxed">선택한 실적 이력이 삭제되며<br>전체 합계가 자동으로 재계산됩니다.</p>
            <div class="flex gap-4">
                <button id="history-delete-cancel" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition">취소</button>
                <button id="history-delete-confirm" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition shadow-sm">삭제</button>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let employees = JSON.parse(localStorage.getItem('ems_employees')) || [];
        let selectedId = null;
        let pendingDeleteId = null;
        let pendingHistoryIdx = null;
        let trendChart = null; 

        // --- DOM ---
        const el = {
            list: document.getElementById('employee-list'),
            emptyState: document.getElementById('empty-state'),
            detailDashboard: document.getElementById('detail-dashboard'),
            totalPerf: document.getElementById('summary-total-perf'),
            avgRate: document.getElementById('summary-avg-rate'),
            summaryCount: document.getElementById('summary-count'),
            toast: document.getElementById('toast'),
            confirmModal: document.getElementById('confirm-modal'),
            historyEditModal: document.getElementById('history-edit-modal'),
            historyDeleteModal: document.getElementById('history-delete-modal'),
            detailName: document.getElementById('detail-name'),
            progressBar: document.getElementById('progress-bar'),
            displayCurrent: document.getElementById('display-current'),
            displayPercentage: document.getElementById('display-percentage'),
            statTarget1: document.getElementById('stat-target1'),
            statTarget2: document.getElementById('stat-target2'),
            statAchieved: document.getElementById('stat-achieved'),
            statRemaining: document.getElementById('stat-remaining'),
            marker1: document.getElementById('marker1'),
            marker2: document.getElementById('marker2'),
            historyList: document.getElementById('performance-history'),
            trendChartCanvas: document.getElementById('trendChart'),
            addDateInput: document.getElementById('add-date-input'),
            addValueInput: document.getElementById('add-value-input')
        };

        el.addDateInput.value = '2026-02-02';

        // --- Utilities ---
        function saveData() { localStorage.setItem('ems_employees', JSON.stringify(employees)); }
        function formatWon(val) { return (val || 0).toLocaleString() + '원'; }
        function showToast(msg) {
            el.toast.innerText = msg;
            el.toast.style.opacity = '1';
            setTimeout(() => el.toast.style.opacity = '0', 2000);
        }

        function updateSummary() {
            const total = employees.reduce((sum, emp) => sum + (emp.current || 0), 0);
            const validEmps = employees.filter(e => e.target2 > 0);
            const avg = validEmps.length > 0 
                ? employees.reduce((sum, emp) => sum + (emp.target2 > 0 ? (emp.current / emp.target2 * 100) : 0), 0) / employees.length 
                : 0;
            el.totalPerf.innerText = formatWon(total);
            el.avgRate.innerText = `${Math.round(avg)}%`;
            el.summaryCount.innerText = `${employees.length}명`;
        }

        // --- Data Sync Logic (숫자 변환 강화) ---
        function recalculateAllData() {
            employees.forEach(emp => {
                // Ensure targets are numbers
                emp.target1 = Number(emp.target1);
                emp.target2 = Number(emp.target2);

                if (emp.history && Array.isArray(emp.history)) {
                    emp.history.sort((a, b) => new Date(a.date) - new Date(b.date));
                    let sum = 0;
                    emp.history.forEach(h => {
                        // FORCE NUMBER TYPE
                        h.amount = Number(h.amount);
                        sum += h.amount;
                        h.totalAfter = sum;
                    });
                    emp.current = sum;
                } else {
                    emp.current = 0;
                    emp.history = [];
                }
            });
            saveData();
            updateSummary();
            renderList();
            if (selectedId) {
                const emp = employees.find(e => e.id === selectedId);
                if (emp) updateDetailUI(emp);
            }
            showToast('데이터가 동기화되었습니다.');
        }

        // --- Render List ---
        function renderList() {
            el.list.innerHTML = '';
            if (employees.length === 0) {
                el.list.innerHTML = '<div class="text-center col-span-full py-12 text-slate-300 text-lg italic font-medium">등록된 설계사가 없습니다.</div>';
            } else {
                const sortedEmployees = [...employees].sort((a, b) => {
                    const rateA = a.target2 > 0 ? (a.current / a.target2) : 0;
                    const rateB = b.target2 > 0 ? (b.current / b.target2) : 0;
                    return rateB - rateA;
                });

                sortedEmployees.forEach(emp => {
                    const rate = emp.target2 > 0 ? Math.round((emp.current / emp.target2) * 100) : 0;
                    const isActive = emp.id === selectedId;
                    
                    const isTarget2Achieved = emp.current >= emp.target2;
                    const isTarget1Achieved = emp.current >= emp.target1;

                    // 카드 스타일 동적 적용 (2차 달성 시 다크모드)
                    let cardClasses = `employee-item w-full p-4 border rounded-[24px] shadow-sm hover:shadow-md transition-all duration-300 `;
                    let nameClass = "font-bold text-lg md:text-xl truncate tracking-tight ";
                    let percentClass = "text-2xl md:text-3xl font-semibold tabular-nums leading-none flex-shrink-0 ";
                    let deleteBtnClass = "list-delete-btn transition px-1 py-1 flex-shrink-0 ";
                    let trackClass = "w-full h-2.5 rounded-full overflow-hidden shadow-inner ";

                    if (isTarget2Achieved) {
                        // Dark Mode
                        cardClasses += "bg-slate-800 border-slate-700";
                        if (isActive) cardClasses += " ring-2 ring-blue-400 border-transparent";
                        else cardClasses += " hover:bg-slate-700";
                        
                        nameClass += "text-white";
                        percentClass += "text-blue-300"; 
                        deleteBtnClass += "text-slate-500 hover:text-red-400";
                        trackClass += "bg-slate-700";
                    } else {
                        // Light Mode
                        cardClasses += "bg-white border-slate-100";
                        if (isActive) cardClasses += " active ring-2 ring-blue-400 border-transparent";
                        else cardClasses += " hover:border-blue-300";

                        nameClass += "text-slate-700";
                        percentClass += "text-blue-500";
                        deleteBtnClass += "text-slate-200 hover:text-red-400";
                        trackClass += "bg-slate-50";
                    }

                    // 게이지 색상 로직: 빨강 -> 초록 -> 노랑
                    let gaugeColor = 'bg-red-400';
                    if (isTarget2Achieved) {
                        gaugeColor = 'bg-yellow-400';
                    } else if (isTarget1Achieved) {
                        gaugeColor = 'bg-green-400';
                    }

                    // 뱃지
                    let badgeHtml = '';
                    if (isTarget2Achieved) {
                        badgeHtml = `<span class="bg-purple-100 text-purple-700 text-[10px] px-1.5 py-0.5 rounded-md flex items-center gap-1 font-bold flex-shrink-0 animate-fade-in"><i class="fa-solid fa-medal"></i> 2차</span>`;
                    } else if (isTarget1Achieved) {
                        badgeHtml = `<span class="bg-yellow-100 text-yellow-700 text-[10px] px-1.5 py-0.5 rounded-md flex items-center gap-1 font-bold flex-shrink-0 animate-fade-in"><i class="fa-solid fa-medal"></i> 1차</span>`;
                    }

                    const item = document.createElement('div');
                    item.className = cardClasses;

                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <span class="${nameClass}">${emp.name}</span>
                                ${badgeHtml}
                                <button class="${deleteBtnClass}" onclick="event.stopPropagation(); openDeleteModal(${emp.id})">
                                    <i class="fa-solid fa-trash-can text-base"></i>
                                </button>
                            </div>
                            <span class="${percentClass}">${rate}%</span>
                        </div>
                        <div class="${trackClass}">
                            <div class="h-full ${gaugeColor} rounded-full" style="width: ${Math.min(rate, 100)}%"></div>
                        </div>
                    `;
                    item.onclick = () => selectEmployee(emp.id);
                    el.list.appendChild(item);
                });
            }
            updateSummary();
        }

        function selectEmployee(id) {
            selectedId = id;
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            el.emptyState.classList.add('hidden');
            el.detailDashboard.classList.remove('hidden');
            el.detailName.innerText = emp.name;
            document.getElementById('target1-input').value = emp.target1;
            document.getElementById('target2-input').value = emp.target2;
            updateDetailUI(emp);
            renderList();
            setTimeout(() => {
                el.detailDashboard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 150);
        }

        function updateDetailUI(emp) {
            // 숫자 변환 및 재계산 보장
            emp.target1 = Number(emp.target1);
            emp.target2 = Number(emp.target2);
            emp.history.sort((a, b) => new Date(a.date) - new Date(b.date));
            let cumulative = 0;
            emp.history.forEach(h => {
                cumulative += Number(h.amount);
                h.totalAfter = cumulative;
            });
            emp.current = cumulative;

            const rate = emp.target2 > 0 ? (emp.current / emp.target2) * 100 : 0;
            const marker1Pos = emp.target2 > 0 ? (emp.target1 / emp.target2) * 100 : 0;

            el.progressBar.style.width = `${Math.min(rate, 100)}%`;
            el.progressBar.className = 'progress-bar'; 
            
            // 상세 대시보드 게이지 색상 로직 통일 (빨강 -> 초록 -> 노랑)
            // (이전 코드에서 잘못된 부분 수정됨)
            if (emp.current >= emp.target2) el.progressBar.classList.add('bg-yellow-400');
            else if (emp.current >= emp.target1) el.progressBar.classList.add('bg-green-400');
            else el.progressBar.classList.add('bg-red-400');
            
            el.marker1.style.left = `${marker1Pos}%`;
            el.marker2.style.left = `100%`;

            el.displayCurrent.innerText = formatWon(emp.current);
            el.displayPercentage.innerText = `${Math.round(rate)}%`;
            el.statTarget1.innerText = formatWon(emp.target1);
            el.statTarget2.innerText = formatWon(emp.target2);
            el.statAchieved.innerText = formatWon(emp.current);
            
            const rem = emp.target2 - emp.current;
            el.statRemaining.innerText = rem > 0 ? formatWon(rem) : '달성 완료';
            // 달성 완료 시 색상도 2차 달성(보라/노랑) 톤으로 가는게 좋겠지만 
            // 여기선 기존 텍스트 로직 유지하되 게이지바는 위에서 통일함
            el.statRemaining.className = `text-lg font-bold ${rem > 0 ? 'text-red-400' : 'text-green-500'}`;

            renderHistoryList(emp);
            renderTrendChart(emp); 
        }

        function renderHistoryList(emp) {
            if (emp.history.length === 0) {
                el.historyList.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm font-medium">실적 기록이 없습니다.</div>';
            } else {
                el.historyList.innerHTML = [...emp.history].reverse().map((item, idx) => {
                    const originalIdx = emp.history.length - 1 - idx;
                    const displayDate = item.date.split('-').slice(1).map(Number).join('/');
                    return `
                        <div class="history-item flex justify-between items-center group p-3 rounded-2xl hover:bg-slate-50 transition">
                            <div>
                                <div class="text-[11px] text-slate-400 mb-1 font-medium">${displayDate}</div>
                                <div class="text-lg font-bold text-slate-700">+${formatWon(item.amount)}</div>
                                <div class="text-[11px] text-slate-400">당시 누적 합계: ${formatWon(item.totalAfter)}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openHistoryEditModal(${originalIdx})" class="w-10 h-10 flex items-center justify-center text-slate-300 hover:bg-blue-50 hover:text-blue-500 rounded-xl transition">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button onclick="openHistoryDeleteModal(${originalIdx})" class="w-10 h-10 flex items-center justify-center text-slate-300 hover:bg-red-50 hover:text-red-500 rounded-xl transition">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderTrendChart(emp) {
            if (trendChart) trendChart.destroy();
            const ctx = el.trendChartCanvas.getContext('2d');
            const labels = [];
            for (let d = 2; d <= 26; d++) { labels.push(d); }
            const dataPoints = labels.map(dayNum => {
                const targetDateStr = `2026-02-${dayNum.toString().padStart(2, '0')}`;
                const targetDate = new Date(targetDateStr);
                const validEntriesSum = emp.history
                    .filter(h => new Date(h.date) <= targetDate)
                    .reduce((sum, h) => sum + Number(h.amount), 0);
                return validEntriesSum;
            });
            const target1Line = labels.map(() => emp.target1);
            const target2Line = labels.map(() => emp.target2);

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '실적 현황', data: dataPoints, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.05)', borderWidth: 2, fill: true, tension: 0.2, pointRadius: 0, hoverRadius: 5, zIndex: 10 },
                        { label: '1차 목표', data: target1Line, borderColor: '#4ade80', borderWidth: 2, fill: false, pointRadius: 0, zIndex: 5 },
                        { label: '2차 목표', data: target2Line, borderColor: '#fbbf24', borderWidth: 2, fill: false, pointRadius: 0, zIndex: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: true, position: 'top', labels: { font: { size: 10, weight: '500' }, boxWidth: 10, padding: 20 } } },
                    scales: {
                        y: { beginAtZero: true, max: emp.target2 > 0 ? emp.target2 : 1000000, ticks: { font: { size: 10 }, callback: (v) => v.toLocaleString() }, grid: { color: '#f8fafc' } },
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        window.openDeleteModal = (id) => { pendingDeleteId = id; el.confirmModal.style.display = 'flex'; };
        document.getElementById('modal-cancel').onclick = () => el.confirmModal.style.display = 'none';
        document.getElementById('modal-confirm').onclick = () => {
            employees = employees.filter(e => e.id !== pendingDeleteId);
            if (selectedId === pendingDeleteId) { selectedId = null; el.detailDashboard.classList.add('hidden'); el.emptyState.classList.remove('hidden'); }
            saveData(); renderList(); el.confirmModal.style.display = 'none'; showToast('설계사가 삭제되었습니다.');
        };

        window.openHistoryEditModal = (idx) => {
            const emp = employees.find(e => e.id === selectedId);
            pendingHistoryIdx = idx;
            document.getElementById('edit-history-input').value = emp.history[idx].amount;
            el.historyEditModal.style.display = 'flex';
        };
        document.getElementById('history-edit-cancel').onclick = () => el.historyEditModal.style.display = 'none';
        document.getElementById('history-edit-confirm').onclick = () => {
            const emp = employees.find(e => e.id === selectedId);
            const newVal = parseInt(document.getElementById('edit-history-input').value);
            if (isNaN(newVal) || newVal < 0) return showToast("금액을 확인하세요.");
            emp.history[pendingHistoryIdx].amount = newVal;
            saveData(); updateDetailUI(emp); renderList(); el.historyEditModal.style.display = 'none'; showToast("수정되었습니다.");
        };

        window.openHistoryDeleteModal = (idx) => { pendingHistoryIdx = idx; el.historyDeleteModal.style.display = 'flex'; };
        document.getElementById('history-delete-cancel').onclick = () => el.historyDeleteModal.style.display = 'none';
        document.getElementById('history-delete-confirm').onclick = () => {
            const emp = employees.find(e => e.id === selectedId);
            emp.history.splice(pendingHistoryIdx, 1);
            saveData(); updateDetailUI(emp); renderList(); el.historyDeleteModal.style.display = 'none'; showToast("삭제되었습니다.");
        };

        document.getElementById('add-emp-btn').onclick = () => {
            const nameInput = document.getElementById('new-emp-name');
            const name = nameInput.value.trim();
            if (!name) return showToast('이름을 입력하세요.');
            const newEmp = { id: Date.now(), name, target1: 1000000, target2: 1200000, current: 0, history: [] };
            employees.push(newEmp); saveData(); nameInput.value = ''; renderList(); selectEmployee(newEmp.id); showToast('추가되었습니다.');
        };

        document.getElementById('add-perf-btn').onclick = () => {
            if (!selectedId) return;
            const val = parseInt(el.addValueInput.value);
            const selectedDate = el.addDateInput.value;
            if (!selectedDate || isNaN(val) || val <= 0) return showToast('날짜와 금액을 확인하세요.');
            const emp = employees.find(e => e.id === selectedId);
            emp.history.push({ date: selectedDate, amount: val, totalAfter: 0 });
            saveData(); el.addValueInput.value = ''; updateDetailUI(emp); renderList(); showToast('반영되었습니다.');
        };

        document.getElementById('set-goals-btn').onclick = () => {
            if (!selectedId) return;
            const t1 = parseInt(document.getElementById('target1-input').value);
            const t2 = parseInt(document.getElementById('target2-input').value);
            if (isNaN(t1) || t2 <= t1) return showToast('2차 목표가 1차보다 커야 합니다.');
            const emp = employees.find(e => e.id === selectedId);
            emp.target1 = t1; emp.target2 = t2; saveData(); updateDetailUI(emp); renderList(); showToast('저장되었습니다.');
        };

        document.getElementById('reset-btn').onclick = () => {
            if (!selectedId || !confirm("초기화하시겠습니까?")) return;
            const emp = employees.find(e => e.id === selectedId);
            emp.current = 0; emp.history = []; saveData(); updateDetailUI(emp); renderList(); showToast('초기화되었습니다.');
        };

        document.getElementById('delete-emp-btn').onclick = () => openDeleteModal(selectedId);
        document.getElementById('refresh-btn').onclick = recalculateAllData;

        window.onload = () => {
            recalculateAllData();
        };
    </script>
</body>
</html>
